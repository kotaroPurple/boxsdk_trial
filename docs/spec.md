# BOX 自動アップロード MVP 仕様

## 背景と目的
- センサデータがローカル PC に 1 分ごとに CSV で保存される。
- 実験後の手動ドラッグ&ドロップによる BOX アップロードは人的ミスが起きやすい。
- BOX SDK (JWT 認証) を使い、CSV を自動アップロードする MVP を作る。

## スコープ
- 対象ファイル: ローカル指定ディレクトリ内の拡張子 `.csv`。
- 対象タイミング: ユーザーがアップロードを開始すると、未アップロードの CSV を順次処理。
- 成果物: Python スクリプト (CLI) と最小限の設定ファイル (.env を想定)。
- 非スコープ: GUI、リアルタイム監視デーモン、BOX 側メタデータ管理の高度化。

## 動作フロー (想定)
1. `.env` から BOX JWT 設定とローカル監視パス、アップロード先フォルダ ID を読み込む。
2. ローカル監視ディレクトリを走査し、未アップロードの CSV をリストアップ。
3. 1 ファイルずつ BOX 指定フォルダへアップロード。
4. 成功したファイルをローカルに記録 (例: `.upload_log.json` または `.uploaded` ディレクトリ移動)。
5. 処理完了をログ出力。エラーは継続可能な限りリトライし、失敗は一覧化。

## 擬似データ生成による試験
- 目的: 本番データを使わず、MVP の動作を通しで確認する。
- 手順:
  1. `LOCAL_DATA_DIR` 配下に簡易ダミー CSV を生成する CLI サブコマンドを用意
     (例: `python -m box_uploader make-dummy --rows 5 --files 3` で 3 ファイル生成)。
  2. 生成後に存在確認を行い、リストアップ結果を INFO ログで表示。
  3. 通常のアップロードコマンドを実行し、BOX 指定フォルダへ送信。
  4. アップロード済みログに反映し、重複防止が効くことを確認。
- 要件:
  - ダミー CSV は小さなサイズ (数行) で、ヘッダ付きにする。
  - 本番設定と同じ `.env` を利用し、BOX 側はテスト用フォルダ ID を指定。
  - 生成とアップロードを分けたサブコマンドで、手動で流れを確認できるようにする。

## 設定 (.env 例)
- `BOX_CLIENT_ID`  
- `BOX_CLIENT_SECRET`  
- `BOX_JWT_PRIVATE_KEY` (PEM 文字列)  
- `BOX_JWT_PASSPHRASE`  
- `BOX_JWT_KEY_ID` (公開鍵 ID)  
- `BOX_ENTERPRISE_ID`  
- `BOX_APP_USER_ID` (アプリユーザー利用時)  
- `BOX_UPLOAD_FOLDER_ID` (アップロード先フォルダ ID)  
- `LOCAL_DATA_DIR` (CSV 置き場)  
- `UPLOAD_LOG_PATH` (既定: `.upload_log.json`)  

## エラー処理・リトライ
- BOX API の一時エラーは指数バックオフで最大 N 回 (デフォルト 3) リトライ。
- 恒久的エラーはスキップし、ログにファイル名と理由を記録。

## ロギング
- `logging` を使用し、INFO で進捗、WARNING/ERROR で失敗を出力。
- 併せてアップロード済みファイル一覧を JSON で保持し、重複アップロードを防止。

## セキュリティ
- 認証情報は `.env` にのみ保持し、gitignore する。
- アップロード済みログに機密データを書かない (ファイル名のみ)。
- 秘密鍵読み込み時はメモリに保持し、ファイルとして残さない。

## テスト方針
- 単体テスト: ローカルファイル走査、アップロード済み判定、ログ更新をモックで確認。
- BOX SDK への実通信はオプションの統合テストで扱う (CI ではスキップ可能な設計)。

## MVP 成功条件
- `.env` を用意し、CLI を 1 コマンド実行すると未アップロード CSV が BOX 指定フォルダへ送られる。
- 重複アップロードが起きない。
- 失敗時に理由がわかるログが残る。

## 今後の拡張アイデア
- 監視型 (ファイル出現をリアルタイム検知) への発展。
- ファイル名パターンやメタデータによる振り分け。
- 進捗ダッシュボード、メール/Slack 通知。
